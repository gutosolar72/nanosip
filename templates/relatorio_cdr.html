{% extends "base.html" %}
{% block content %}
<div class="card">
    <center><h3>Relatório de Chamadas</h3></center>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Data/Hora</th>
                <th>Origem</th>
                <th>Destino</th>
                <th>Duração (s)</th>
                <th>Falado (s)</th>
                <th>Status</th>
                {% if has_record %}
                <th>Gravação</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for r in registros %}
            <tr>
                <td>{{ r.calldate }}</td>
                <td>{{ r.src }}</td>
                <td>{{ r.dst }}</td>
                <td>{{ r.duration }}</td>
                <td>{{ r.billsec }}</td>
                <td style="color:
                    {% if r.disposition == 'Atendida' %}blue
                    {% elif r.disposition == 'Ocupado' %}red
                    {% else %}black
                    {% endif %}">{{ r.disposition }}
               </td>
               {% if has_record %}
               <td>
                   {% if r.recording %}
                   <a href="#" data-bs-toggle="modal" data-bs-target="#audioModal" data-src="{{ r.recording }}">
                       <i class="fas fa-play-circle" style="color:green; cursor:pointer;"></i>
                   </a>
                   {% else %}
                       -
                   {% endif %}
               </td>
               {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Paginação -->
<nav>
    <ul class="pagination">

        {# Página anterior #}
        <li class="page-item {% if page == 1 %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('relatorios.relatorio_cdr', page=page-1) }}">&laquo;</a>
        </li>

        {# Páginas #}
        {% for p in paginas %}
            {% if p %}
                <li class="page-item {% if p == page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('relatorios.relatorio_cdr', page=p) }}">{{ p }}</a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link">…</span>
                </li>
            {% endif %}
        {% endfor %}

        {# Próxima #}
        <li class="page-item {% if page == total_pages %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('relatorios.relatorio_cdr', page=page+1) }}">&raquo;</a>
        </li>

    </ul>
</nav>

</div>

{% if has_record %}
<!-- Modal para reprodução de gravação -->
<div class="modal fade" id="audioModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <h5>Reprodução da Gravação</h5>
      <audio id="audioPlayer" controls style="width:100%;">
        <source src="" type="audio/wav">
        Seu navegador não suporta áudio.
      </audio>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  var audioModal = document.getElementById('audioModal')
  audioModal.addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget
    var src = button.getAttribute('data-src')
    var player = document.getElementById('audioPlayer')
    player.querySelector('source').src = src
    player.load()
  })
})
</script>
{% endif %}
{% endblock %}

